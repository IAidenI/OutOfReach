#include "functions.h"

unsigned long GetPlayerOffset(int pid) {
    char cmd[256];
    snprintf(cmd, sizeof(cmd), "nm /proc/%d/exe 2>/dev/null | awk '$3==\"player\"{print \"0x\"$1; exit}'", pid);

    FILE *fp = popen(cmd, "r");
    if (!fp) {
        perror("popen");
        fprintf(stderr, "[-] Impossible de récupèrer l'offset du joueur.\n");
        return -1;
    }

    char buf[64] = { 0 };
    if (!fgets(buf, sizeof(buf), fp)) {
        pclose(fp);
        return -1;
    }
    pclose(fp);
    return strtoul(buf, NULL, 16);
}

int GetValue(int pid, off_t address, float *getValue) {
    // Lit la RAM du processus
    char memoryPath[64];
    snprintf(memoryPath, sizeof(memoryPath), "/proc/%d/mem", pid);
    int memory = open(memoryPath, O_RDONLY);

    if (memory == -1) {
        perror("open");
        fprintf(stderr, "[-] Impossible d'accèder au fichier %s\n", memoryPath);
        return 1;
    }

    // Se place au niveau de l'offset
    if (lseek(memory, address, SEEK_SET) == (off_t)-1) {
        perror("lseek");
        fprintf(stderr, "[-] Impossible de trouver l'offset.\n");
        close(memory);
        return 1;
    }

    // Lit la valeur
    if (read(memory, getValue, sizeof(*getValue)) != sizeof(*getValue)) {
        perror("read");
        fprintf(stderr, "[-] Impossible de trouver la donnée.\n");
        close(memory);
        return 1;
    }

    close(memory);
    return 0;
}

int SetValue(int pid, off_t address, float newValue) {
    // Lit la RAM du processus
    char memoryPath[PATH_SIZE];
    snprintf(memoryPath, sizeof(memoryPath), "/proc/%d/mem", pid);
    int memory = open(memoryPath, O_RDWR);

    if (memory == -1) {
        perror("open");
        fprintf(stderr, "[-] Impossible d'accèder au fichier %s\n", memoryPath);
        return 1;
    }

    // Se place au niveau de l'offset
    if (lseek(memory, address, SEEK_SET) == (off_t)-1) {
        perror("lseek");
        fprintf(stderr, "[-] Impossible de trouver l'offset.\n");
        close(memory);
        return 1;
    }

    // Lit la valeur
    if (write(memory, &newValue, sizeof(newValue)) != sizeof(newValue)) {
        perror("read");
        fprintf(stderr, "[-] Impossible de trouver la donnée.\n");
        close(memory);
        return 1;
    }

    close(memory);
    return 0;
}

int GetELFBase(int pid, uintptr_t *elfBase) {
    // Lit le chemin d'accès du fichier exécuté
    char exeLink[64];
    snprintf(exeLink, sizeof(exeLink), "/proc/%d/exe", pid);

    char exeRealPath[256];
    ssize_t len = readlink(exeLink, exeRealPath, sizeof(exeRealPath) - 1);
    if (len == -1) {
        perror("readlink");
        return 1;
    }
    exeRealPath[len] = '\0';

    // Récupère l'adresse de base
    char mapsPath[PATH_SIZE];
    snprintf(mapsPath, sizeof(mapsPath), "/proc/%d/maps", pid);
    
    FILE *maps = fopen(mapsPath, "r");
    if (maps == NULL) {
        perror("open");
        fprintf(stderr, "[-] Impossible d'accèder au fichier %s\n", mapsPath);
        return 1;
    }

    char line[512];
    while (fgets(line, sizeof(line), maps)) {
        unsigned long start, end;
        char perms[5] = { 0 };
        unsigned long offset;
        char path[256] = { 0 };
        
        int n = sscanf(line, "%lx-%lx %4s %lx %*s %*s %255s", &start, &end, perms, &offset, path);

        if (n == 5) {
            if (strstr(line, exeRealPath) != NULL && offset == 0) {
                *elfBase = start;
                break;
            }
        }
    }
    fclose(maps);
    return 0;
}

bool Teleport(int pid, Position3D newPosition, RuntimeAddr address) {
    // Récupère les anciennes valeurs
    Position3D oldPosition = { 0.0f };
    float oldValue = 0;
    if (GetValue(pid, (off_t)address.positionX, &oldValue)) return 1;
    oldPosition.x += oldValue;

    if (GetValue(pid, (off_t)address.positionY, &oldValue)) return 1;
    oldPosition.y += oldValue;

    if (GetValue(pid, (off_t)address.positionZ, &oldValue)) return 1;
    oldPosition.z += oldValue;

    if (SetValue(pid, (off_t)address.positionX, newPosition.x)) return 1;
    if (SetValue(pid, (off_t)address.positionY, newPosition.y)) return 1;
    if (SetValue(pid, (off_t)address.positionZ, newPosition.z)) return 1;

    printf("[+] Joueur téléporté de X=%.2f;Y=%.2f;Z=%.2f en X=%.2f;Y=%.2f;Z=%.2f", oldPosition.x, oldPosition.y, oldPosition.y, newPosition.x, newPosition.y, newPosition.z);
}
