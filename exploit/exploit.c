#include "functions.h"

int main(int argc, char **argv) {
    if (argc < 2) {
        fprintf(stderr, "Usage : %s <pid>\n", argv[0]);
        return 1;
    }

    // S'attache au processus cible
    int pid = atoi(argv[1]);
    if (ptrace(PTRACE_ATTACH, pid, NULL, NULL)) {
        perror("ptrace(PTRACE_ATTACH)");
        fprintf(stderr, "[-] Impossible de s'attacher au processus.\n");
        return 1;
    }

    waitpid(pid, NULL, 0); // Attend la pause du processus

    // Récupère l'adresse de base du binaire
    uintptr_t elfBase = 0;
    if (GetELFBase(pid, &elfBase)) {
        ptrace(PT_DETACH, pid, NULL, NULL);
        return 1;
    }

    if (elfBase == 0) {
        printf("[-] ELF base introuvable.\n");
    } else {
        printf("[+] ELF base : 0x%lx.\n", (unsigned long)elfBase);
    }

    // Ajoute l'offset de la variable cible
    unsigned long elfPlayerOffset = GetPlayerOffset(pid);
    if (elfPlayerOffset == -1) {
        ptrace(PT_DETACH, NULL, NULL);
        return 1;
    }
    printf("[+] Addresse ELF du joueur : 0x%lx\n", elfPlayerOffset);
    size_t posXOffset = offsetof(PlayerLayout, position) + offsetof(Position3DLayout, x);
    size_t posYOffset = offsetof(PlayerLayout, position) + offsetof(Position3DLayout, y);
    size_t posZOffset = offsetof(PlayerLayout, position) + offsetof(Position3DLayout, z);

    unsigned long elfPosXOffset = elfPlayerOffset + posXOffset;
    unsigned long elfPosYOffset = elfPlayerOffset + posYOffset;
    unsigned long elfPosZOffset = elfPlayerOffset + posZOffset;

    RuntimeAddr address = {
        elfBase + elfPosXOffset,
        elfBase + elfPosYOffset,
        elfBase + elfPosZOffset
    };
    printf("[+] Adresse de player.position.x : 0x%lx\n", (unsigned long)address.positionX);
    printf("[+] Adresse de player.position.y : 0x%lx\n", (unsigned long)address.positionY);
    printf("[+] Adresse de player.position.z : 0x%lx\n", (unsigned long)address.positionZ);

    if (Teleport(pid, { 0.0f, 50.0f, 0.0f }, address)) {
        ptrace(PT_DETACH; NULL, NULL);
        return 1;
    }

    ptrace(PT_DETACH, pid, NULL, NULL);
    return 0;
}
